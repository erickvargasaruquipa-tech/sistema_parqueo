{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
    <h3>Buscar Salida</h3>

    <!-- Formulario de búsqueda -->
    <form method="POST" class="mb-4">
        <div class="row">
            <div class="col-md-4 mb-2">
                <input type="text" name="placa" class="form-control" placeholder="Placa del vehículo">
            </div>
            <div class="col-md-4 mb-2">
                <input type="text" name="ci" class="form-control" placeholder="C.I. del cliente">
            </div>
            <div class="col-md-4 mb-2">
                <button type="submit" class="btn btn-primary w-100">Buscar</button>
            </div>
        </div>
    </form>

    {% if registro %}
    <div class="card">
        <div class="card-body">

            <!-- DATOS DEL CLIENTE -->
            <h5>Datos del Cliente</h5>
            <div class="mb-2">
                <label>Nombre completo</label>
                <input type="text" class="form-control" value="{{ registro.cliente.nombre }} {{ registro.cliente.apellido_paterno }} {{ registro.cliente.apellido_materno }}" readonly>
            </div>
            <div class="mb-2">
                <label>C.I.</label>
                <input type="text" class="form-control" value="{{ registro.cliente.ci }}" readonly>
            </div>
            <div class="mb-2">
                <label>Teléfono</label>
                <input type="text" class="form-control" value="{{ registro.cliente.telefono }}" readonly>
            </div>

            <!-- DATOS DEL VEHÍCULO -->
            <h5 class="mt-3">Datos del Vehículo</h5>
            <div class="mb-2">
                <label>Placa</label>
                <input type="text" class="form-control" value="{{ registro.vehiculo.placa }}" readonly>
            </div>
            <div class="mb-2">
                <label>Tipo</label>
                <input type="text" class="form-control" value="{{ registro.vehiculo.tipo }}" readonly>
            </div>
            <div class="mb-2">
                <label>Marca</label>
                <input type="text" class="form-control" value="{{ registro.vehiculo.marca }}" readonly>
            </div>
            <div class="mb-2">
                <label>Modelo</label>
                <input type="text" class="form-control" value="{{ registro.vehiculo.modelo }}" readonly>
            </div>
            <div class="mb-2">
                <label>Color</label>
                <input type="text" class="form-control" value="{{ registro.vehiculo.color }}" readonly>
            </div>

            <!-- TIEMPOS -->
            <h4 class="mt-4">Datos de Tiempo</h4>
            <div class="mb-2">
                <label>Hora de ingreso</label>
                <input type="text" class="form-control" value="{{ registro.fecha_ingreso.strftime('%Y-%m-%d %H:%M:%S') }}" readonly>
            </div>
            <div class="mb-2">
                <label>Hora de salida (en tiempo real)</label>
                <input type="text" id="horaSalida" class="form-control" readonly>
            </div>
            <div class="mb-3">
                <label>Tiempo transcurrido</label>
                <input type="text" id="tiempoTranscurrido" class="form-control" style="font-size: 30px; font-weight: bold; text-align:center;" readonly>
            </div>

            <!-- FORMULARIO PARA CONFIRMAR SALIDA -->
            <form method="POST" action="{{ url_for('salida_controller.confirmar_salida', registro_id=registro.id_registro) }}">
                <div class="mb-4">
                    <label>Monto a pagar (Bs)</label>
                    <input type="number" id="montoPagar" name="monto" value="0" step="0.5"
                           class="form-control"
                           style="font-size: 40px; height: 70px; text-align:center; font-weight:bold;">
                </div>
                <button type="submit" class="btn btn-danger mt-3 w-100">Confirmar salida</button>
            </form>

        </div>
    </div>
    {% else %}
        {% if request.method == 'POST' %}
            <div class="alert alert-warning mt-3">
                No se encontró ningún registro activo que coincida con PLACA + C.I.
            </div>
        {% endif %}
    {% endif %}
</div>

{% if registro %}
<script>
// --- ACTUALIZAR HORA DE SALIDA EN TIEMPO REAL ---
function actualizarHoraSalida() {
    const ahora = new Date();
    document.getElementById("horaSalida").value =
        ahora.getFullYear() + "-" +
        String(ahora.getMonth()+1).padStart(2, '0') + "-" +
        String(ahora.getDate()).padStart(2, '0') + " " +
        String(ahora.getHours()).padStart(2, '0') + ":" +
        String(ahora.getMinutes()).padStart(2, '0') + ":" +
        String(ahora.getSeconds()).padStart(2, '0');
}

// --- TIEMPO TRANSCURRIDO Y MONTO ---
const ingreso = new Date("{{ registro.fecha_ingreso.strftime('%Y-%m-%d %H:%M:%S') }}");
let montoEditable = false;
const montoInput = document.getElementById("montoPagar");
montoInput.addEventListener("input", () => { montoEditable = true; });

function calcularMonto(minutos, precioHora) {
    const precio10Min = precioHora / 6;
    if (minutos < 10) return 0;
    else if (minutos < 30) return 3 * precio10Min; // media hora
    else {
        let bloques10 = Math.ceil(minutos / 10);
        return bloques10 * precio10Min;
    }
}

function actualizarTiempoTranscurrido() {
    const ahora = new Date();
    let diffSeg = Math.floor((ahora - ingreso)/1000);
    const horas = Math.floor(diffSeg / 3600);
    diffSeg %= 3600;
    const minutos = Math.floor(diffSeg / 60);
    const segundos = diffSeg % 60;
    document.getElementById("tiempoTranscurrido").value = 
        `${String(horas).padStart(2,'0')}:${String(minutos).padStart(2,'0')}:${String(segundos).padStart(2,'0')}`;

    // Actualizamos monto solo si usuario no lo editó
    if(!montoEditable) {
        const precioHora = {{ registro.vehiculo.tarifa.precio_hora if registro.vehiculo.tarifa else 5 }};
        montoInput.value = calcularMonto(horas*60 + minutos, precioHora).toFixed(2);
    }
}

// Ejecutar cada segundo
setInterval(() => {
    actualizarHoraSalida();
    actualizarTiempoTranscurrido();
}, 1000);

actualizarHoraSalida();
actualizarTiempoTranscurrido();
</script>
{% endif %}

{% endblock %}
